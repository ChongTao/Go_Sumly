# 1 Slice的底层原理

在Go语言中，切片（slice）的底层数据结构主要包括三个关键属性：指针、长度和容量。 切片不是数组，它是一个 **结构体**。

```go
type slice struct {
    array unsafe.Pointer // 指向底层数组
    len   int
    cap   int
}
```

- **指针**：指向底层数组的第一个元素。这个指针使得切片能够引用数组的一段连续区域，从而实现动态数组的功能。
- **长度**：表示当前切片中元素的数量。这是切片的一个重要属性，它决定了切片当前包含多少个元素。

- **容量**：从切片的开始位置到底层数组的结尾位置的元素数量。容量总是大于等于长度，它表示切片在不重新分配底层数组的情况下可以容纳的元素数量。

## 1.1 Slice的特点

1. **动态长度**：与数组不同，切片的长度是动态的，可以在运行时增长或缩小。这使得切片非常适合处理不确定大小的数据集合。
2. **引用类型**：切片是引用类型，它们不存储任何数据，只描述底层数组的一段。因此，对切片的修改会影响到其底层数组。这种特性使得切片在函数传参和共享内存方面非常高效。
3. **自动扩容**：当向切片添加元素时，如果切片的当前容量不足以容纳新元素，Go语言会自动进行扩容操作。这通常涉及到创建一个新的底层数组，并将原切片的数据复制到新数组中。扩容操作确保了切片能够灵活地适应数据的变化。

## 1.2 Slice的内存模型

```go
s := []int{1, 2, 3}
```

内存结构:

```lua
stack/heap:
┌──────────────┐
│ Data pointer │───┐
│ Len = 3      │   │
│ Cap = 3      │   │
└──────────────┘   │
                   ▼
            ┌──────────────┐
            │ 1 | 2 | 3    │  ← 底层数组
            └──────────────┘
```



## 1.3 Slice是引用语义

```go
func f(s []int) {
    s[0] = 100
}

func main() {
    x := []int{1, 2, 3}
    f(x)
    fmt.Println(x) // [100 2 3]
}
```

- 函数传参时 **只拷贝 slice header**
- `Data` 指针仍指向同一块数组，修改的是同一块内存

> 切片不是引用类型，而是值拷贝+内部共享指针



## 1.4 Slice扩容

slice（切片）是一个动态数组，其容量（cap）和长度（len）可以随着元素的添加而自动调整。当向slice中添加元素时，如果当前容量不足以容纳新元素，slice会进行扩容。

```go
s := make([]int, 0, 2)
s = append(s, 1, 2)
s = append(s, 3) // 触发扩容
```

runtime.growslice

```go
newcap := oldcap * 2
if oldcap >= 1024 {
    newcap += newcap / 4
}
```

1. **判断当前容量是否足够**：首先，Go语言会检查当前slice的容量是否足够容纳新添加的元素。如果当前容量足够，则直接将新元素追加到slice中，无需进行扩容。
2. **扩容策略**：如果当前容量不足，Go语言会根据一定的策略进行扩容。在Go 1.7之前和之后的版本中，扩容策略有所不同。
   - 在Go 1.7之前，如果当前容量小于1024，则将容量翻倍；如果当前容量大于等于1024，则将容量增加1.25倍。
   - 在Go 1.8及之后的版本中，扩容策略进行了改进。如果当前容量小于256，则将容量翻倍；如果当前容量大于等于256且小于4096，则将容量增加1.5倍；如果当前容量大于等于4096，则将容量增加1.25倍。
3. **分配新的内存空间**：根据新的容量，Go语言会分配一块新的内存空间来存储扩容后的slice。
4. **拷贝旧数据**：将原slice中的数据拷贝到新的内存空间中。这个过程通常是浅拷贝，即只拷贝slice中的元素值，而不拷贝底层数组本身。

>  slice的扩容操作可能会涉及到底层数组的重新分配和数据的拷贝，因此在实际使用中应尽量避免频繁扩容，以提高性能。可以通过预估容量来创建合适大小的slice，以减少扩容的次数。

## 1.5 Slice和数组之间差异

| 维度     | 数组（array）          | 切片（slice）     |
| -------- | ---------------------- | ----------------- |
| 类型系统 | `[N]T`，N 是类型一部分 | `[]T`             |
| 本质     | 实际数据块             | 结构体描述符      |
| 内存     | 一整块连续内存         | header + 底层数组 |
| 传参     | 拷贝全部元素           | 拷贝 header       |
| 扩容     | ❌ 不支持               | ✅ growslice       |
| 共享底层 | ❌                      | ✅                 |
| 长度     | 固定                   | 动态              |
| 指针     | 无                     | 有                |
