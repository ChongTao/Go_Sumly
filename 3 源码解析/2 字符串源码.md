# 一 String底层原理

**Go 的 `string` 是一个“只读的字节序列视图（read-only byte slice view）”**

## 1.1 String底层结构

```go
// runtime/string.go（概念模型）
type stringStruct struct {
    data unsafe.Pointer
    len  int
}

// 在 reflect 包中StringHeader
type StringHeader struct {
    Data uintptr
    Len  int
}
```

一个`string`变量本身只占一个8字节指针（64位）和8字节长度。

## 1.2 内存布局

```go
s := "hello"
```

内存大致如下:

```dart
string struct        底层只读字节区
+-----------+        +---------------------+
| Data -----+------->| 'h' 'e' 'l' 'l' 'o' |
| Len = 5   |        +---------------------+
+-----------+
```

`string`本身不存数据，只是引用“底层字节数组”。

## 1.3 string不可变

`string`不可变意味其值不可修改，由编译器禁止修改。主要原因（很多语言都将字符串设置不可变）：

- 共享同一块底层内存
- 避免并发修改带来数据竞争

## 1.4 string 的切片操作（零拷贝）

```go
s := "hello world"
sub := s[6:11] // "world"
```

其底层行为，切片是不拷贝字节

```go
sub.data = s.data + 6
sub.len  = 5
```



## 1.5 string 与 UTF-8 / rune 的关系

1. string ≠ 字符序列

```go
s := "中"
fmt.Println(len(s)) // 3
```

- string 存的是 UTF-8 字节
- `len` 返回字节数

2. rune 是 int32（Unicode code point）

```go
for _, r := range s {
    fmt.Println(r)
}
```

## 1.6 string 与 []byte 的关系（底层对比）

| 对比项   | string         | []byte          |
| -------- | -------------- | --------------- |
| 底层结构 | ptr + len      | ptr + len + cap |
| 可变性   | ❌              | ✅               |
| 扩容     | ❌              | ✅               |
| 是否拷贝 | 转换时通常拷贝 | 转换时通常拷贝  |
| 并发安全 | ✅              | ❌               |
